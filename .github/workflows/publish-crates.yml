name: Publish crates to crates.io

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: Publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # good practice when working with tags

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Optional: sanity checks before publish
      - name: Show version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Releasing version: $VERSION"

      # Publish all changed crates in the right order, waiting for deps as needed
      - name: Publish workspace crates
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          # Explicit path to ensure correct publish order
          path: './quillmark-core'
          # args passed to `cargo publish`:
          args: --locked
          # helpful toggles:
          ignore-unpublished-changes: true   # exit 0 if nothing needs publishing
          check-repo: true                   # check if crate is already published
          
      - name: Publish quillmark-typst
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          path: './quillmark-typst'
          args: --locked
          ignore-unpublished-changes: true
          check-repo: true
          
      - name: Publish quillmark
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          path: './quillmark'
          args: --locked
          ignore-unpublished-changes: true
          check-repo: true

      - name: Summary
        if: always()
        run: echo "Publishing complete. Check individual steps for details."Run katyo/publish-crates@v2
Searching cargo packages at '.'
/home/runner/.cargo/bin/cargo metadata --no-deps --format-version 1 --manifest-path Cargo.toml
{"packages":[{"name":"quillmark-core","version":"0.0.4","id":"path+file:///home/runner/work/quillmark/quillmark/quillmark-core#0.0.4","license":"Apache-2.0","license_file":null,"description":"Core types and functionality for Quillmark","source":null,"dependencies":[{"name":"anyhow","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"minijinja","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~2.12","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"serde","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":["derive"],"target":null,"registry":null},{"name":"serde_json","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"serde_yaml","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~0.9","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"thiserror","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~2.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"toml","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~0.9","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"tempfile","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~3.23","kind":"dev","rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null}],"targets":[{"kind":["lib"],"crate_types":["lib"],"name":"quillmark_core","src_path":"/home/runner/work/quillmark/quillmark/quillmark-core/src/lib.rs","edition":"2021","doc":true,"doctest":true,"test":true}],"features":{},"manifest_path":"/home/runner/work/quillmark/quillmark/quillmark-core/Cargo.toml","metadata":null,"publish":null,"authors":[],"categories":[],"keywords":[],"readme":"../README.md","repository":null,"homepage":null,"documentation":null,"edition":"2021","links":null,"default_run":null,"rust_version":null},{"name":"quillmark","version":"0.0.4","id":"path+file:///home/runner/work/quillmark/quillmark/quillmark#0.0.4","license":"Apache-2.0","license_file":null,"description":"Quillmark engine API","source":null,"dependencies":[{"name":"anyhow","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"quillmark-core","source":null,"req":"^0.0.4","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark-core"},{"name":"quillmark-typst","source":null,"req":"^0.0.4","kind":null,"rename":null,"optional":true,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark-typst"},{"name":"serde","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":["derive"],"target":null,"registry":null},{"name":"serde_yaml","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~0.9","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"thiserror","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~2.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"quillmark-fixtures","source":null,"req":"*","kind":"dev","rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark-fixtures"},{"name":"quillmark-typst","source":null,"req":"^0.0.4","kind":"dev","rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark-typst"},{"name":"tempfile","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~3.23","kind":"dev","rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null}],"targets":[{"kind":["lib"],"crate_types":["lib"],"name":"quillmark","src_path":"/home/runner/work/quillmark/quillmark/quillmark/src/lib.rs","edition":"2021","doc":true,"doctest":true,"test":true},{"kind":["example"],"crate_types":["bin"],"name":"appreciated_letter","src_path":"/home/runner/work/quillmark/quillmark/quillmark/examples/appreciated_letter.rs","edition":"2021","doc":false,"doctest":false,"test":false},{"kind":["example"],"crate_types":["bin"],"name":"taro","src_path":"/home/runner/work/quillmark/quillmark/quillmark/examples/taro.rs","edition":"2021","doc":false,"doctest":false,"test":false},{"kind":["example"],"crate_types":["bin"],"name":"usaf_memo","src_path":"/home/runner/work/quillmark/quillmark/quillmark/examples/usaf_memo.rs","edition":"2021","doc":false,"doctest":false,"test":false},{"kind":["test"],"crate_types":["bin"],"name":"common","src_path":"/home/runner/work/quillmark/quillmark/quillmark/tests/common.rs","edition":"2021","doc":false,"doctest":false,"test":true},{"kind":["test"],"crate_types":["bin"],"name":"dynamic_assets_test","src_path":"/home/runner/work/quillmark/quillmark/quillmark/tests/dynamic_assets_test.rs","edition":"2021","doc":false,"doctest":false,"test":true},{"kind":["test"],"crate_types":["bin"],"name":"feature_flag_test","src_path":"/home/runner/work/quillmark/quillmark/quillmark/tests/feature_flag_test.rs","edition":"2021","doc":false,"doctest":false,"test":true},{"kind":["test"],"crate_types":["bin"],"name":"fixture_test","src_path":"/home/runner/work/quillmark/quillmark/quillmark/tests/fixture_test.rs","edition":"2021","doc":false,"doctest":false,"test":true},{"kind":["test"],"crate_types":["bin"],"name":"quill_engine_test","src_path":"/home/runner/work/quillmark/quillmark/quillmark/tests/quill_engine_test.rs","edition":"2021","doc":false,"doctest":false,"test":true}],"features":{"default":["typst"],"typst":["dep:quillmark-typst"]},"manifest_path":"/home/runner/work/quillmark/quillmark/quillmark/Cargo.toml","metadata":null,"publish":null,"authors":[],"categories":[],"keywords":[],"readme":"../README.md","repository":null,"homepage":null,"documentation":null,"edition":"2021","links":null,"default_run":null,"rust_version":null},{"name":"quillmark-typst","version":"0.0.4","id":"path+file:///home/runner/work/quillmark/quillmark/quillmark-typst#0.0.4","license":"Apache-2.0","license_file":null,"description":"Typst backend for Quillmark","source":null,"dependencies":[{"name":"anyhow","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"dirs","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^6.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"fontdb","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.21.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"pulldown-cmark","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.13.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"quillmark-core","source":null,"req":"^0.0.4","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark-core"},{"name":"serde_json","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~1.0","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"time","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.3.44","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":["formatting","parsing"],"target":null,"registry":null},{"name":"toml","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~0.9","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"typst","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.13.1","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"typst-kit","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.13.1","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"typst-pdf","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.13.1","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"typst-svg","source":"registry+https://github.com/rust-lang/crates.io-index","req":"^0.13.1","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null},{"name":"tempfile","source":"registry+https://github.com/rust-lang/crates.io-index","req":"~3.23","kind":"dev","rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null}],"targets":[{"kind":["lib"],"crate_types":["lib"],"name":"quillmark_typst","src_path":"/home/runner/work/quillmark/quillmark/quillmark-typst/src/lib.rs","edition":"2021","doc":true,"doctest":true,"test":true}],"features":{},"manifest_path":"/home/runner/work/quillmark/quillmark/quillmark-typst/Cargo.toml","metadata":null,"publish":null,"authors":[],"categories":[],"keywords":[],"readme":"../README.md","repository":null,"homepage":null,"documentation":null,"edition":"2021","links":null,"default_run":null,"rust_version":null},{"name":"quillmark-fixtures","version":"0.0.4","id":"path+file:///home/runner/work/quillmark/quillmark/quillmark-fixtures#0.0.4","license":"MIT","license_file":null,"description":"Test fixtures and utilities for Quillmark","source":null,"dependencies":[{"name":"quillmark","source":null,"req":"^0.0.4","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark"},{"name":"quillmark-typst","source":null,"req":"^0.0.4","kind":null,"rename":null,"optional":false,"uses_default_features":true,"features":[],"target":null,"registry":null,"path":"/home/runner/work/quillmark/quillmark/quillmark-typst"}],"targets":[{"kind":["lib"],"crate_types":["lib"],"name":"quillmark_fixtures","src_path":"/home/runner/work/quillmark/quillmark/quillmark-fixtures/src/lib.rs","edition":"2021","doc":true,"doctest":true,"test":true}],"features":{},"manifest_path":"/home/runner/work/quillmark/quillmark/quillmark-fixtures/Cargo.toml","metadata":null,"publish":[],"authors":[],"categories":[],"keywords":[],"readme":null,"repository":null,"homepage":null,"documentation":null,"edition":"2021","links":null,"default_run":null,"rust_version":null}],"workspace_members":["path+file:///home/runner/work/quillmark/quillmark/quillmark-core#0.0.4","path+file:///home/runner/work/quillmark/quillmark/quillmark#0.0.4","path+file:///home/runner/work/quillmark/quillmark/quillmark-typst#0.0.4","path+file:///home/runner/work/quillmark/quillmark/quillmark-fixtures#0.0.4"],"workspace_default_members":["path+file:///home/runner/work/quillmark/quillmark/quillmark-core#0.0.4","path+file:///home/runner/work/quillmark/quillmark/quillmark#0.0.4","path+file:///home/runner/work/quillmark/quillmark/quillmark-typst#0.0.4","path+file:///home/runner/work/quillmark/quillmark/quillmark-fixtures#0.0.4"],"resolve":null,"target_directory":"/home/runner/work/quillmark/quillmark/target","version":1,"workspace_root":"/home/runner/work/quillmark/quillmark","metadata":null}
{
  "quillmark-core": {
    "path": "quillmark-core",
    "version": "0.0.4",
    "dependencies": {
      "anyhow": {
        "kind": null,
        "req": "~1.0"
      },
      "minijinja": {
        "kind": null,
        "req": "~2.12"
      },
      "serde": {
        "kind": null,
        "req": "~1.0"
      },
      "serde_json": {
        "kind": null,
        "req": "~1.0"
      },
      "serde_yaml": {
        "kind": null,
        "req": "~0.9"
      },
      "thiserror": {
        "kind": null,
        "req": "~2.0"
      },
      "toml": {
        "kind": null,
/home/runner/.cargo/bin/cargo publish --locked
    Updating crates.io index
warning: manifest has no documentation, homepage or repository.
See https://doc.rust-lang.org/cargo/reference/manifest.html#package-metadata for more info.
   Packaging quillmark v0.0.4 (/home/runner/work/quillmark/quillmark/quillmark)
warning: ignoring example `appreciated_letter` as `examples/appreciated_letter.rs` is not included in the published package
warning: ignoring example `taro` as `examples/taro.rs` is not included in the published package
warning: ignoring example `usaf_memo` as `examples/usaf_memo.rs` is not included in the published package
warning: ignoring test `common` as `tests/common.rs` is not included in the published package
warning: ignoring test `dynamic_assets_test` as `tests/dynamic_assets_test.rs` is not included in the published package
warning: ignoring test `feature_flag_test` as `tests/feature_flag_test.rs` is not included in the published package
warning: ignoring test `fixture_test` as `tests/fixture_test.rs` is not included in the published package
warning: ignoring test `quill_engine_test` as `tests/quill_engine_test.rs` is not included in the published package
    Updating crates.io index
error: failed to prepare local package for uploading

Caused by:
  failed to select a version for the requirement `quillmark-typst = "^0.0.4"`
  candidate versions found which didn't match: 0.0.3
  location searched: crates.io index
  required by package `quillmark v0.0.4 (/home/runner/work/quillmark/quillmark/quillmark)`