name: Publish crates to crates.io

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: Publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # good practice when working with tags

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Optional: sanity checks before publish
      - name: Show version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Releasing version: $VERSION"

      # Publish all changed crates in the right order, waiting for deps as needed
      - name: Publish quillmark-core
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          # Explicit path to ensure correct publish order
          path: './quillmark-core'
          # args passed to `cargo publish`:
          args: --locked
          # helpful toggles:
          ignore-unpublished-changes: true   # exit 0 if nothing needs publishing
          check-repo: true                   # check if crate is already published
          
      - name: Publish quillmark-typst
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          path: './quillmark-typst'
          args: --locked
          ignore-unpublished-changes: true
          check-repo: true
          
      - name: Publish quillmark
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          path: './quillmark'
          args: --locked
          ignore-unpublished-changes: true
          check-repo: true

      - name: Summary
        if: always()
        run: echo "Publishing complete. Check individual steps for details."
